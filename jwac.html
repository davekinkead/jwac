<!DOCTYPE html>
<meta charset="utf-8">
<title>JWAC Training Analysis</title>
<style>

  #chart {
    margin: 1em;
  }

</style>
<body>

<h1>JWAC Analysis & Forecasting</h1>

<div id="chart"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="sankey.js"></script>
<script>

  var gates = ["NEOC", "JWAC 1", "JWAC 2", "MSB", "JWAC 3 Shore", "JWAC 3 Sea", "Fleet Board", "NOLC1", "JWAC Warfare", "JWAC Simulator", "JWAC Endorsement"];

  var width = 1200, height = 500;

  var svg = d3.select('#chart')
    .append('svg')
    .attr('width', width)
    .attr('height', height)

  var sumNodes = function(nodes) {
    return nodes.map(function(node) { 
        return node.members.length;
      }).reduce(function(prev, curr) { 
        return prev + curr;
      }); 
  }

  var createNodes = function(buckets) {
    var gate = 0;

    return [].concat.apply([], buckets.map(function(bucket) {
      var nodes = Object.keys(bucket).map(function(name) {
        return {"name": name, "members": bucket[name], "gate": gate }
      });
      gate++;
      return positionNodesVertically(nodes);
    }));
  }

  var positionNodesVertically = function(nodes) {
    var denominator = sumNodes(nodes), pos = 0;

    return nodes.sort(function(a, b) { 
        return b.members.length - a.members.length;
      }).map(function(node) {
        node.y = pos / denominator * height + 1;
        node.height = node.members.length / denominator * height - 1;
        pos += node.members.length;
        return node;
      });
  }

  var createBuckets = function(data) {
    var buckets = []

    data.forEach(function(member) {
      member.postings.forEach(function(posting, i) {
        if (buckets[i] == undefined)
          buckets[i] = {};
        if (buckets[i].hasOwnProperty(posting)) {
          buckets[i][posting].push(member.id);
        } else {
          buckets[i][posting] = [member.id];
        }
      });
    });

    return buckets;    
  }

  var createLinks = function(nodes, data) {
    var links = Array.apply(null, Array(nodes.length)).map(function() { return []; });

    nodes.forEach(function(node, index) {
      nodes.forEach(function(n, i) {
        if (node.gate == n.gate - 1 && index !== i)
          node.members.forEach(function(id) {
            if (n.members.indexOf(id) !== -1)
              if (links[index].hasOwnProperty(i))
                links[index][i] += 1;
              else
                links[index][i] = 0;
          });
      });


    });

    var results = []
    links.forEach(function(array, index) {
      array.forEach(function(el, i) {
        results.push ({"source": index, "target": i, "value": el});
      });        
    });
    return results;
  }


  d3.json('data.json', function(json) {

    var buckets = createBuckets(json)
    var nodes = createNodes(buckets);
    var links = createLinks(nodes, json)

    console.log(links);

    svg.append('g')
      .selectAll('rect')
      .data(nodes)
      .enter()
      .append('rect')
      .attr('x', function(d) { return d.gate * 150 })
      .attr('y', function(d) { return d.y })
      .attr('width', 50) //function(d) { return nodeWidth(node); })
      .attr('height', function(d) { return d.height })
      .attr('fill', '#2E86D1')
      .attr('opacity', 0.25)
      .append('title')
      .text(function(d) { return d.name + ' (' + d.members.length + ')' }); 

  });

</script>

</body>
</html>
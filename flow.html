<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>JWAC Sensitivity Analysis</title>
  <style>

    body { text-align: center; margin: 0; padding: 0; color: #444;}

    #chart { margin: 1em; }
    #info { position: absolute; bottom: 50px; right: 50px; width: 300px; height: 200px; border: 1px solid #CCC; padding: 1em; box-shadow: 1px 1px 5px rgba(0,0,0,0.5); }

    .node:hover { opacity: 0.5; }
    .link:hover { opacity: 0.325; }
    
    div.tooltip { position: absolute; width: auto; height: auto; padding: 1em; font: 12px sans-serif; background: #EFEFEF; border: 0px; border-radius: 5px; pointer-events: none;
    }
    h4 {margin: 0; padding: 0;}
  </style>
</head>
<body>

<h1>JWAC Flow Analysis</h1>

<div id="chart"></div>
<div id="tooltip"></div>

<script src="d3.js"></script>
<script src="utils.js"></script>
<script>

  var gates = ["NEOC", "ADFA", "Transfer", "Changeover", "JWAC 1", "JWAC 2", "MSB", "JWAC 3 Shore", "JWAC 3 Sea", "Fleet Board", "NOLC1", "JWAC Warfare", "JWAC Simulator", "JWAC Endorsement"];

  var width = screen.width - 100, height = screen.height - 300, nodeWidth = 50, nodePadding = 2, workingData;

  var svg = d3.select('#chart')
    .append('svg')
    .attr('width', width)
    .attr('height', height);

  var tooltip = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);


  var positionNodesAndLinks = function(nodes, links) {
    var dates = nodes.map(function(n) {
      return n.start;
    });
    timeOffset = convertToDays(Math.min.apply([], dates));

    var timeEnd = timeOffset;
    nodes.forEach(function(n) {
      n.x = convertToDays(n.start) - timeOffset;
      n.width = convertToDays(n.finish) - convertToDays(n.start) - 1;
      n.y = 0;
      n.height = n.members.length * 5;
      timeEnd = Math.max(timeEnd, n.width)
    });

    bufferNodesVertically(nodes);
    svg.attr('width', timeEnd)
  }

  var bufferNodesVertically = function(nodes) {

    nodes.forEach(function(node, i) {
      for(var t=0; t<i; t++) {
        if (nodes[t].finish >= node.start && nodes[t].start <= node.finish ) {
          node.y = nodes[t].height + nodes[t].y;
          height = Math.max(height, node.y + node.height);
        }
      }
    });

    svg.attr('height', height);
    // var nodesByDate = d3.nest()
    //   .key(function(d) { return d.start })
    //   .entries(nodes);

    // nodesByDate.forEach(function(dateGroup) {
    //   var offset = 0;
    //   if (dateGroup.values.length > 1) {
    //     dateGroup.values.forEach(function(n) {
    //       n.y += offset;
    //       offset += n.height;          
    //     });
    //   }
    // });

    // console.log(nodes);
    // nodes.forEach(function(node, i) {
    //   if (i > 0) {
    //     if (nodes[i-1].finish >= nodes[i].start && nodes[i-1].start <= nodes[i].finish && nodes[i-1].height >= nodes[i].y) {
    //       node.y = nodes[i-1].height;
    //     } 
    //   }
    // }); 
  }

  function renderChart(data) {
  
    var colour = function(target) {
      if (gates.indexOf(target) !== -1) {
        return '#08306B';
      } else {
        return '#666';
      }
    }  

    workingData = data;

    var nodes = createDatedNodesFromPostingHistory(workingData);

    positionNodesAndLinks(nodes);

    var node = svg.selectAll('.node')
      .data(nodes);

    node.enter()
      .append('g')
      .append('rect')
      .attr('class', 'node')
      .attr('x', function(d) { return d.x })
      .attr('y', function(d) { return d.y })
      .attr('width', function(d) { return d.width })
      .attr('height', function(d) { return d.height })
      .attr('opacity', 0.375)
      .on('mouseover', function(d) {
        tooltip.transition()        
          .duration(200)      
          .style("opacity", .9);      
        tooltip.html('<h4>'+d.billet +"</h4>"+ d.start.toDateString() +"-"+ d.finish.toDateString() +"<br/>"+ d.members.length + " JOUTs")  
          .style("left", (d3.event.pageX) + "px")     
          .style("top", (d3.event.pageY - 28) + "px");    
      })
      .on('mouseout', function(d) {
        tooltip.transition()
          .duration(200)
          .style("opacity", 0);
      })
      .on('dblclick', function(d) { 
        workingData = workingData.filter(function(datum) {
          return (d.members.indexOf(datum.id) !== -1);
        });
        renderChart(workingData);
      })
      .append('title');

    node.transition()
      .attr('x', function(d) { return d.x })
      .attr('y', function(d) { return d.y })
      .attr('height', function(d) { return d.height })
      .attr('fill', function(d) { return colour(d.billet) })
    
    node.exit()
      .remove();
  }


  d3.json('data.json', function(json) {

    renderChart(json);
    d3.select('#info').on('dblclick', function() {renderChart(json)} );
 
  });

</script>

</body>
</html>